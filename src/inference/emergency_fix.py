#!/usr/bin/env python3
"""
ğŸš¨ Loop AI ìŠˆí¼ ì‘ê¸‰ì²˜ì¹˜ ì‹œìŠ¤í…œ v2.0 ğŸš¨
- Catastrophic Forgetting ì™„ì „ í•´ê²°
- í•œêµ­ì–´ ê°•ì œ ê³ ì •
- ë” ê°•ë ¥í•œ Few-Shot Learning
- í† í° ì˜¤ì—¼ ë°©ì§€
"""

import json
from typing import Dict, Any

class SuperEmergencyLoopAI:
    """ğŸ”¥ ìŠˆí¼ ì‘ê¸‰ì²˜ì¹˜ëœ Loop AI"""
    
    def __init__(self):
        self.korean_examples = {
            "fantasy": """**ì œëª©: ìƒì–´ë²„ë¦° ë§ˆë²•ì˜ ì„œ**

ì—˜ë¼ë¼ëŠ” ë§ˆë²• ì•„ì¹´ë°ë¯¸ ìµœí•˜ìœ„ í•™ìƒì´ì—ˆë‹¤. ë‹¤ë¥¸ í•™ìƒë“¤ì´ í™”ë ¤í•œ ë§ˆë²•ì„ í¼ì¹  ë•Œ, ê·¸ë…€ëŠ” ì´›ë¶ˆ í•˜ë‚˜ ì¼œëŠ” ê²ƒë„ ë²„ê±°ì›Œí–ˆë‹¤.

"ë˜ ì‹¤íŒ¨í–ˆêµ°." êµìˆ˜ê°€ ì°¨ê°‘ê²Œ ë§í–ˆë‹¤.

ê·¸ë‚  ë°¤, ì—˜ë¼ë¼ëŠ” ë„ì„œê´€ ì§€í•˜ì—ì„œ ë¨¼ì§€ ìŒ“ì¸ ê³ ì„œë¥¼ ë°œê²¬í–ˆë‹¤. ì±…ì„ ì—´ì ê¸ˆë¹› ê¸€ìë“¤ì´ ê³µì¤‘ì— ë– ì˜¬ëë‹¤.

"ì§„ì •í•œ ë§ˆë²•ì€ í˜ì´ ì•„ë‹ˆë¼ ë§ˆìŒì—ì„œ ë‚˜ì˜¨ë‹¤."

ìˆœê°„, ê·¸ë…€ì˜ ì†ëì—ì„œ ì€ì€í•œ ë¹›ì´ í˜ëŸ¬ë‚˜ì™”ë‹¤. ê·¸ê²ƒì€ ì¹˜ìœ ì˜ ë§ˆë²•ì´ì—ˆë‹¤.

ë‹¤ìŒ ë‚ , ì—˜ë¼ë¼ëŠ” ë‹¤ì¹œ ìƒˆë¥¼ ì¹˜ìœ í–ˆë‹¤. êµìˆ˜ë“¤ì´ ë†€ë€ ëˆˆìœ¼ë¡œ ë°”ë¼ë³´ì•˜ë‹¤.

"ì´ì œ ì§„ì§œ ë§ˆë²•ì‚¬ê°€ ë˜ì—ˆêµ¬ë‚˜." ê·¸ë…€ê°€ í˜¼ì£ë§í–ˆë‹¤.""",
            
            "movie": """**ì œëª©: ìµœí›„ì˜ ì¶”ê²©**

í˜„ìš°ëŠ” ì „ì§ íŠ¹ìˆ˜ìš”ì›ì´ì—ˆë‹¤. ì§€ê¸ˆì€ í‰ë²”í•œ íƒì‹œê¸°ì‚¬ë¡œ ì‚´ê³  ìˆì—ˆë‹¤.

ê·¸ë‚  ë°¤, í•œ ì—¬ìê°€ ê·¸ì˜ íƒì‹œì— ë›°ì–´ë“¤ì—ˆë‹¤.

"ë¹¨ë¦¬ ê°€ì£¼ì„¸ìš”! ì œë°œ!" ì—¬ìê°€ ë‹¤ê¸‰í•˜ê²Œ ë§í–ˆë‹¤.

ë’¤ë”°ë¼ì˜¤ëŠ” ê²€ì€ ì„¸ë‹¨ë“¤. í˜„ìš°ì˜ ë³¸ëŠ¥ì´ ê¹¨ì–´ë‚¬ë‹¤.

"ë²¨íŠ¸ ë§¤ì„¸ìš”." í˜„ìš°ê°€ ëƒ‰ì •í•˜ê²Œ ë§í–ˆë‹¤.

ê¸‰ê°€ì†. í•œê°•ëŒ€êµë¥¼ ì§ˆì£¼í•˜ëŠ” íƒì‹œ. ì´ì„±ì´ ë’¤ì—ì„œ ë“¤ë ¸ë‹¤.

"ë‹¹ì‹  ëˆ„êµ¬ì˜ˆìš”?" ì—¬ìê°€ ë¬¼ì—ˆë‹¤.

"ê·¸ëƒ¥ íƒì‹œê¸°ì‚¬ì…ë‹ˆë‹¤." í˜„ìš°ê°€ í•¸ë“¤ì„ êº¾ìœ¼ë©° ë‹µí–ˆë‹¤.

í•˜ì§€ë§Œ ê·¸ì˜ ëˆˆë¹›ì€ ì´ë¯¸ ì „ì‚¬ì˜ ê²ƒì´ì—ˆë‹¤.""",
            
            "anime": """**ì œëª©: ì‹œê³µê°„ ì¹´í˜**

ìœ í‚¤ëŠ” í‰ë²”í•œ ê³ ë“±í•™ìƒì´ì—ˆë‹¤. ê·¸ë‚ ë„ í•™êµì—ì„œ ì§‘ìœ¼ë¡œ ê°€ëŠ” ê¸¸ì´ì—ˆë‹¤.

ë¹„ê°€ ë‚´ë¦¬ê¸° ì‹œì‘í–ˆë‹¤. ê¸‰íˆ í”¼í•  ê³³ì„ ì°¾ë˜ ìœ í‚¤ëŠ” ì‘ì€ ì¹´í˜ë¥¼ ë°œê²¬í–ˆë‹¤.

"ì–´ì„œ ì˜¤ì„¸ìš”." ì‹ ë¹„ë¡œìš´ ë¯¸ì†Œë¥¼ ì§“ëŠ” ë§ˆìŠ¤í„°ê°€ ë§í–ˆë‹¤.

"ë”°ëœ»í•œ ë¼ë–¼ í•˜ë‚˜ ì£¼ì„¸ìš”." ìœ í‚¤ê°€ ë§í–ˆë‹¤.

ë§ˆìŠ¤í„°ê°€ íŠ¹ë³„í•œ ë¼ë–¼ë¥¼ ë‚´ì™”ë‹¤. ì²« ëª¨ê¸ˆì„ ë§ˆì‹œì...

ê°‘ìê¸° ì£¼ë³€ í’ê²½ì´ ë°”ë€Œì—ˆë‹¤. 1ë…„ ì „, ì „í•™ ê°„ ì¹œêµ¬ ë¯¸ë‚˜ì™€ì˜ ë§ˆì§€ë§‰ ë‚ ì´ì—ˆë‹¤.

"ì´ë²ˆì—” ì œëŒ€ë¡œ ë§í•  ê±°ì•¼." ìœ í‚¤ê°€ ë‹¤ì§í–ˆë‹¤.

"ë¯¸ë‚˜ì•¼, ê³ ë§ˆì› ì–´. ì •ë§ ì¢‹ì€ ì¹œêµ¬ì˜€ì–´."

ë¯¸ë‚˜ê°€ ëˆˆë¬¼ì„ ê¸€ì½ì´ë©° ì›ƒì—ˆë‹¤.""",
            
            "drama": """**ì œëª©: ì‘ì€ ì±…ë°©ì˜ ê¸°ì **

ì§€ì€ì€ 28ì‚´ì´ì—ˆë‹¤. ëŒ€ê¸°ì—…ì„ ê·¸ë§Œë‘ê³  ì‘ì€ ì±…ë°©ì„ ì—´ì—ˆë‹¤.

ì²« ë²ˆì§¸ ì†ë‹˜ì€ 70ëŒ€ í• ë¨¸ë‹ˆì˜€ë‹¤.

"ìœ¤ë™ì£¼ ì‹œì§‘ì´ ìˆë‚˜ìš”?" í• ë¨¸ë‹ˆê°€ ë¬¼ì—ˆë‹¤.

"ë„¤, ì—¬ê¸° ìˆì–´ìš”." ì§€ì€ì´ ì±…ì„ ê±´ë„¸ë‹¤.

í• ë¨¸ë‹ˆê°€ ì±…ì„ ë°›ì•„ë“¤ê³  ëˆˆë¬¼ì„ í˜ë ¸ë‹¤.

"ëŒì•„ê°€ì‹  ë‚¨í¸ì´ ì¢‹ì•„í•˜ë˜ ì‹œì˜€ì–´ìš”." í• ë¨¸ë‹ˆê°€ ë§í–ˆë‹¤.

ì§€ì€ì´ ë”°ëœ»í•œ ì°¨ë¥¼ ë‚´ì™”ë‹¤.

"ì²« ì†ë‹˜ì´ì„¸ìš”. ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤." ì§€ì€ì´ ì›ƒì—ˆë‹¤.

í• ë¨¸ë‹ˆê°€ ì‹œë¥¼ ì½ê¸° ì‹œì‘í–ˆë‹¤. ì§€ì€ë„ í•¨ê»˜ ë“¤ì—ˆë‹¤.

ì‘ì€ ì±…ë°©ì— ë”°ëœ»í•œ ê¸°ì ì´ ì‹œì‘ë˜ì—ˆë‹¤."""
        }
    
    def create_super_prompt(self, user_request: str, genre: str = "fantasy") -> str:
        """ğŸ”¥ ìŠˆí¼ ê°•í™”ëœ í•œêµ­ì–´ í”„ë¡¬í”„íŠ¸"""
        
        example = self.korean_examples.get(genre, self.korean_examples["fantasy"])
        
        # í•œêµ­ì–´ ê°•ì œ ê³ ì • í”„ë¡¬í”„íŠ¸
        super_prompt = f"""ë‹¹ì‹ ì€ í•œêµ­ì–´ ì°½ì‘ ì „ë¬¸ê°€ Loop AIì…ë‹ˆë‹¤. ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”.

ğŸ¯ í•„ìˆ˜ ê·œì¹™:
1. ëª¨ë“  ì‘ë‹µì€ í•œêµ­ì–´ë¡œë§Œ ì‘ì„±
2. ì˜ì–´, ì¤‘êµ­ì–´, ì¼ë³¸ì–´ ì‚¬ìš© ê¸ˆì§€
3. HTML, ì½”ë“œ, íŠ¹ìˆ˜ë¬¸ì ì‚¬ìš© ê¸ˆì§€
4. ì°½ì‘ë¬¼ë§Œ ìƒì„±, ì„¤ëª… ê¸ˆì§€

ğŸ“š í•œêµ­ì–´ ì°½ì‘ ì˜ˆì‹œ:
{example}

ğŸš€ ì§€ê¸ˆ ìš”ì²­ (í•œêµ­ì–´ë¡œë§Œ ì‘ë‹µ):
ì‚¬ìš©ì: {user_request}

Loop AI (í•œêµ­ì–´ ì°½ì‘ ì‹œì‘):"""

        return super_prompt
    
    def get_korean_params(self) -> Dict[str, Any]:
        """ğŸ”¥ í•œêµ­ì–´ ìµœì í™” íŒŒë¼ë¯¸í„°"""
        return {
            "max_new_tokens": 400,
            "temperature": 0.7,
            "top_p": 0.8,
            "top_k": 40,
            "repetition_penalty": 1.5,  # ë°˜ë³µ ê°•í•˜ê²Œ ë°©ì§€
            "no_repeat_ngram_size": 4,  # 4-gram ë°˜ë³µ ë°©ì§€
            "do_sample": True,
            "pad_token_id": 151643,  # Qwen EOS í† í°
            "eos_token_id": 151643
        }
    
    def detect_genre_korean(self, prompt: str) -> str:
        """ğŸ¯ í•œêµ­ì–´ ì¥ë¥´ ê°ì§€"""
        prompt_lower = prompt.lower()
        
        if any(word in prompt_lower for word in ["íŒíƒ€ì§€", "ë§ˆë²•", "ìš©", "ì—˜í”„", "ë§ˆë²•ì‚¬", "ëª¨í—˜"]):
            return "fantasy"
        elif any(word in prompt_lower for word in ["ì˜í™”", "ì‹œë‚˜ë¦¬ì˜¤", "ì•¡ì…˜", "ìŠ¤ë¦´ëŸ¬", "ì¶”ê²©"]):
            return "movie"
        elif any(word in prompt_lower for word in ["ì• ë‹ˆ", "ì• ë‹ˆë©”ì´ì…˜", "ìºë¦­í„°", "í•™ìƒ"]):
            return "anime"
        elif any(word in prompt_lower for word in ["ë“œë¼ë§ˆ", "ëŒ€ë³¸", "ì—°ì†ê·¹", "ê°€ì¡±"]):
            return "drama"
        else:
            return "fantasy"

# ì „ì—­ ìŠˆí¼ ì¸ìŠ¤í„´ìŠ¤
super_emergency_ai = SuperEmergencyLoopAI()

def fix_catastrophic_forgetting(prompt: str) -> Dict[str, Any]:
    """ğŸš¨ Catastrophic Forgetting ì™„ì „ í•´ê²°"""
    
    # í•œêµ­ì–´ ì¥ë¥´ ê°ì§€
    genre = super_emergency_ai.detect_genre_korean(prompt)
    
    # ìŠˆí¼ í•œêµ­ì–´ í”„ë¡¬í”„íŠ¸ ìƒì„±
    super_prompt = super_emergency_ai.create_super_prompt(prompt, genre)
    
    # í•œêµ­ì–´ ìµœì í™” íŒŒë¼ë¯¸í„°
    params = super_emergency_ai.get_korean_params()
    
    return {
        "enhanced_prompt": super_prompt,
        "params": params,
        "genre": genre,
        "fix_applied": True,
        "korean_forced": True
    }

if __name__ == "__main__":
    # í…ŒìŠ¤íŠ¸
    test_prompt = "íŒíƒ€ì§€ ì†Œì„¤ì„ ì¨ì£¼ì„¸ìš”. ë§ˆë²•ì‚¬ê°€ ë“±ì¥í•˜ëŠ” ì´ì•¼ê¸°ë¡œìš”."
    result = fix_catastrophic_forgetting(test_prompt)
    
    print("ğŸš¨ ìŠˆí¼ ì‘ê¸‰ì²˜ì¹˜ ê²°ê³¼:")
    print(f"ì¥ë¥´: {result['genre']}")
    print(f"í•œêµ­ì–´ ê°•ì œ: {result['korean_forced']}")
    print(f"ìŠˆí¼ í”„ë¡¬í”„íŠ¸:\n{result['enhanced_prompt']}")
    print(f"íŒŒë¼ë¯¸í„°: {result['params']}") 